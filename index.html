<!doctype html>
<!--
Copyright 2011 University of Surrey

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>		<html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>		<html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!-- Consider adding an manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">

	<!-- Use the .htaccess and remove these lines to avoid edge case issues.
			 More info: h5bp.com/b/378 -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Mondat Canvas</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Mobile viewport optimized: j.mp/bplateviewport -->
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->

	<!-- CSS: implied media=all -->
	<!-- CSS concatenated and minified via ant build script-->
	<link rel="stylesheet" href="css/style.css">
	<!-- end CSS-->

	<link rel="stylesheet" href="CodeMirror2/lib/codemirror.css">
	<link rel="stylesheet" href="CodeMirror2/theme/default.css">
	<link rel="stylesheet" href="css/cm/sbvr.css">
		
	<link type="text/css" href="css/ui-lightness/jquery-ui.css" rel="stylesheet" />

	<!-- More ideas for your <head> here: h5bp.com/d/head-Tips -->

	<!-- All JavaScript at the bottom, except for Modernizr / Respond.
			 Modernizr enables HTML5 elements & feature detects; Respond is a polyfill for min/max-width CSS3 Media Queries
			 For optimal performance, use a custom Modernizr build: www.modernizr.com/download/ -->
	<script src="js/libs/modernizr-2.0.6.min.js"></script>
</head>

<body>

		<div id="dialog-message" title="Unable to complete request"></div>
	
	<div id="tabs">
		<ul>
			<li><a href='#modelTab' 		onClick="location.hash='!/model/';return false"	>Model Editor			</a></li>
			<li><a href='#lfTab'															>Logical Formulation	</a></li>
			<li><a href='#prepTab'															>Preprocessed LF		</a></li>
			<li><a href='#sqlTab'   		onClick="location.hash='!/sql/';return false"	>SQL					</a></li>
			<li><a href='#dataTab'  		onClick="location.hash='!/data/';return false"	>Data Browser			</a></li>
			<li><a href='#httpTab'  		onClick="location.hash='!/http/';return false"	>HTTP Log				</a></li>
			<li><a href='#importExportTab'  onClick="location.hash='!/export/';return false">Import/Export Database	</a></li>
		</ul>
		<div id="modelTab">
			<form id="editform">
				<!-- windows wants 189 cols for the textareas -->
				<textarea id="modelArea" rows="15" cols="136"></textarea>
				<div align="right">
					<input type="button" id='blm1' value="Load Model 1"  onClick="loadmod(model1);return false">
					<input type="button" id='blm2' value="Load Model 2"  onClick="loadmod(model2);return false">
					<input type="button" id='blm3' value="Load Model 3"  onClick="loadmod(model3);return false">
					<input type="button" id='blmt' value="Load Test"     onClick="loadmod(modelTest);return false">
					<input type="button" id='bem'  value="Execute Model" onClick="transformClient(sbvrEditor.getValue());return false">
					<input type="button" id='bum'  value="Update Model"  onClick="return false">
					<input type="button" id='br'   value="Reset"         onClick="resetClient();return false">
					<input type="button" id='bbdb' value="Backup DB"     onClick="backupDB();return false">
					<input type="button" id='brdb' value="Restore DB"    onClick="restoreDB();return false">
					<input type="button" id='bcdb' value="Clear DB"      onClick="clearDB();return false">
				</div>
			</form>
		</div>
		<div id="lfTab"><textarea id="lfArea" rows="15" cols="136"></textarea></div>
		<div id="prepTab"><textarea id="prepArea" rows="15" cols="136"></textarea></div>
		<div id="sqlTab"><textarea id="sqlArea" rows="15" cols="136"></textarea></div>
		<div id="dataTab"></div>
		<div id="httpTab">
			<table id='httpTable' class='textTable'>
				<tr>
					<td><strong>method</strong></td>
					<td><strong>uri</strong></td>
					<td><strong>headers</strong></td>
					<td><strong>body</strong></td>
				</tr>
			</table>
		</div>
		<div id="importExportTab">
			<textarea id="importExportArea" rows="15" cols="136"></textarea>
			<script type="text/javascript">
				if(!!window.FileReader)
				{
					document.write('<input type="button" id="bldb" value="Load File">');
					function handleFiles(files) {
						var reader = new FileReader();
						reader.onloadend = function(e) {
							importExportEditor.setValue(e.target.result);
						}
						reader.readAsText(files[0]);
					}
				}
			</script>
			<input type="button" id='bidb' value="Import DB" onClick="importDB(importExportEditor.getValue());return false">
			<input type="button" id='bedb' value="Export DB" onClick="exportDB(importExportEditor);return false">
		</div>
	</div>



	<!-- JavaScript at the bottom for fast page loading -->

	<!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
	<!-- TODO: When we are serving via http then switch back to the google CDN method, but until then it delays loading page fairly considerably :(
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/libs/jquery-1.6.2.min.js"><\/script>')</script>
	-->
	<script src="js/libs/jquery-1.6.2.min.js"></script>


	<!-- scripts concatenated and minified via ant build script-->
	<script defer src="js/plugins.js"></script>
	<script defer src="js/script.js"></script>
	<script defer src="ometa-js/lib.js"></script>
	<script defer src="ometa-js/ometa-base.js"></script>
		
	<script defer src="js/mylibs/json2.js"></script>
		
	<script defer src="js/libs/jquery-1.6.2.min.js"></script>
	<script defer src="js/mylibs/jquery-ui-1.8.11.custom.min.js"></script>
	<script defer src="js/mylibs/jquery-custom-file-input.js"></script>
	<script defer src="js/mylibs/inflection.js"></script>
	
	<script defer src="CodeMirror2/lib/codemirror.js"></script>
	<script defer src="CodeMirror2/mode/plsql/plsql.js"></script>
	
	<script defer src="js/mylibs/cm/sbvr.js"></script>
	<script defer src="js/mylibs/cm/sbvrac.js"></script>
	
	<script defer src='js/mylibs/ometa-code/SBVRParser.js'></script>
	<script defer src='js/mylibs/ometa-code/SBVR_PreProc.js'></script>
	<script defer src='js/mylibs/ometa-code/SBVR2SQL.js'></script>
	<script defer src='js/mylibs/ometa-code/ClientURIParser.js'></script>
	<script defer src='js/mylibs/ometa-code/ClientURIUnparser.js'></script>
	<script defer src='js/mylibs/ometa-code/ServerURIParser.js'></script>
	<script defer src='js/mylibs/ometa-code/Prettify.js'></script>
		
	<script defer src='js/mylibs/ometa-code/SBVRModels.js'></script>
		
	<script defer src="js/mylibs/server.js"></script>
	<script defer src="js/mylibs/drawDataUI.js"></script>
	<script defer src="js/mylibs/runTrans.js"></script>
	<script defer src="js/mylibs/backupRestore.js"></script>
	<!-- end scripts-->
	
	<script defer type='text/javascript'>
		var sqlEditor, sbvrEditor, importExportEditor;
		var cmod;
	
		function defaultFailureCallback(error) {
			console.log(error);
			var exc = '<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>';
			var msg = error['status-line']?error['status-line']:error.join('<br/>');
			$( "#dialog-message" ).html( exc + msg );
			$( "#dialog-message" ).dialog( "open" );
			//console.log("fail!", error);
		}
	
		function defaultSuccessCallback(header, result) {
		}
		
		//should probably JSON.parse result when appropriate. Now the callbacks do it.
		function serverRequest(method, uri, headers, body, successCallback, failureCallback, caller){
			$("#httpTable").append(
				'<tr class="server_row"><td><strong>' + method +
				"</strong></td><td>" + uri + "</td><td>" + (headers.length==0?'':headers) +
				"</td><td>" + body + "</td></tr>"
			);
			remoteServerRequest(method, uri, headers, body,
				typeof successCallback != 'function' ? defaultSuccessCallback : successCallback,
				typeof failureCallback != 'function' ? defaultFailureCallback : failureCallback,
				caller);
		}
	
		//txtmod = '';
		function loadState() {
			serverRequest("GET", "/onAir/", [], '', function(headers, result){
				if(result!=undefined){
					localStorage._client_onAir = JSON.parse(result);
				}
			});
		}
		
		function transformClient(model) {
			$("#modelArea").attr('disabled',true);
			//TODO: Add success/failure callbacks.
			serverRequest("PUT",
				"/ui/textarea-is_disabled*filt:textarea.name=model_area/",
				{"Content-Type":"application/json"},
				JSON.stringify({"value":true}),
				function() {
				
					serverRequest("PUT",
						"/ui/textarea*filt:name=model_area/",
						{"Content-Type":"application/json"},
						JSON.stringify({"value":model}),
						function() {
		
							serverRequest("POST",
								"/execute/",
								{"Content-Type":"application/json"},
								'',
								function() {
						
									//serverRequest("GET", "/model/", [], '', function(headers, result){
									//	txtmod = result;
									//});
								
									serverRequest("GET",
										"/lfmodel/",
										{},
										'',
										function(headers, result) {
											$("#lfArea").val(Prettify.match(JSON.parse(result),'elem'));
		
											serverRequest("GET",
												"/prepmodel/",
												{},
												'',
												function(headers, result) {
													$("#prepArea").val(Prettify.match(JSON.parse(result),'elem'));
													
													serverRequest("GET",
														"/sqlmodel/",
														{},
														'',
														function(headers, result) {
															sqlEditor.setValue(Prettify.match(JSON.parse(result),'elem'));
			
															localStorage._client_onAir=true
															
															$('#bum').removeAttr('disabled');
															$('#br').removeAttr('disabled');
															$('#bem').attr('disabled','disabled');
														}
													);
												}
											);
										}
									);
								}
							);
						}
					);
				}
			);
		}
		
		function updateModel(){
			return true;
		}

		function resetClient(){
			//**actions should go in the callback to be executed after the DELETE.
			serverRequest("DELETE",	"/", [], '', function(){
				$("#modelArea").attr('disabled', false);
				sbvrEditor.setValue("");
				$("#lfArea").val("");
				$("#prepArea").val("");
				sqlEditor.setValue("");
				$('#bem').removeAttr('disabled');
				$('#bum').attr('disabled','disabled');
				$('#br').attr('disabled','disabled');
				localStorage._client_onAir=false;
			});
		}

		function loadmod(model){
			if(!(localStorage._client_onAir=='true')){
				sbvrEditor.setValue(model);
				serverRequest("PUT",
					"/ui/textarea*filt:name=model_area/",
					{"Content-Type":"application/json"},
					JSON.stringify({"value":model})
				);
			}else{
				//Saving the model to the server has failed.
				//TODO: Give some explanation. (SBVR-style?)
			}
		}
		
		function processHash(){
			theHash = location.hash
			if(theHash == ''){
				theHash = '#!/model'
			}
			
			if(theHash.slice(1,9) == '!/server'){
				URItree = [[],[[],['server']]];
			}else{
				URItree = ClientURIParser.matchAll(theHash, 'expr'); //does not handle empty tree
			}
			
			try {
				switchVal = URItree[1][1][0];
			}
			catch($e) {
				switchVal = '';
			}
			
			switch(switchVal) {
				case "server":
					//console.log(location.hash.slice(9));
					uri = location.hash.slice(9);
					serverRequest("GET", uri, "", {}, function(headers, result){
						alert(result);
					});
					break;
				case "sql":
					$('#tabs').tabs("select",3);
					sqlEditor.refresh(); //Force a refresh on switching to the tab, otherwise it wasn't appearing.
					break;
				case "data":
					$('#tabs').tabs("select",4);
					drawData(URItree[1]);
					break;
				case "http":
					$('#tabs').tabs("select",5);
					break;
				case "export":
					$('#tabs').tabs("select",6);
					break;
//					case "model": //Model is the default view.
				default:
					sbvrEditor.refresh();
					$('#tabs').tabs("select",0);
					break;
			}
		}
	
		//break loadUI apart to loadState and SetUI (with a view to converting LoadState to a single request)?
		function loadUI(){
			//request schema from server and store locally.
			if(localStorage._client_onAir=='true'){
				serverRequest("GET", "/model/", [], '', function(headers, result) {
					var ctree = SBVRParser.matchAll(result, 'expr');
					ctree = SBVR_PreProc.match(ctree, "optimizeTree");
					cmod = SBVR2SQL.match(ctree,'trans');
				});
			}
			
			

			sbvrEditor = CodeMirror.fromTextArea(document.getElementById("modelArea"), {
				mode: "sbvr",
				onKeyEvent: sbvrAutoComplete
			});
			sqlEditor = CodeMirror.fromTextArea(document.getElementById("sqlArea"), {mode: "text/x-plsql"});
			importExportEditor = CodeMirror.fromTextArea(document.getElementById("importExportArea"), {mode: "text/x-plsql"});
			
			window.onhashchange = processHash;
			serverRequest("GET", "/ui/textarea*filt:name=model_area/", [], '',
				function(headers, result){
					sbvrEditor.setValue(JSON.parse(result).value);
				}
			)
			
			//TODO: This should be restructured to use jQuery's ajax() interface, so it can be switched
			//between local and remote as needed (preferably with some variable setting)
			//http://api.jquery.com/jQuery.ajax/
			serverRequest("GET", "/ui/textarea-is_disabled*filt:textarea.name=model_area/", [], '',
				function(headers, result){
					$("#modelArea").attr('disabled', JSON.parse(result).value)
				}
			)
			
			//how do we fix this? - ignore. It gets updated on execute anyway. 
			$("#modelArea").change(function(){
				serverRequest("PUT",
					"/ui/textarea*filt:name=model_area/",
					{"Content-Type":"application/json"},
					JSON.stringify({"value":sbvrEditor.getValue()})
				);
			});
			
			if(localStorage._client_onAir=='true'){
				serverRequest("GET", "/lfmodel/", [], '', function(headers, result){
					$("#lfArea").val(Prettify.match(JSON.parse(result),'elem'));
				});
			
				serverRequest("GET", "/prepmodel/", [], '', function(headers, result){
					$("#prepArea").val(Prettify.match(JSON.parse(result),'elem'));
				});
			
				serverRequest("GET", "/sqlmodel/", [], '', function(headers, result){
					sqlEditor.setValue(Prettify.match(JSON.parse(result),'elem'));
				});	
			}
			
			//Prepare dialog
			//$(function() {
				$( "#dialog-message" ).dialog({
					modal: true,
					resizable: false,
					autoOpen: false,
					buttons: {
						"Revise Request": function() {
							$( this ).dialog( "close" );
						},
						"Revise Model": function() {
							$( this ).dialog( "close" );
						}
					}
				});
			//});
			
			//Enable/disable model editor buttons
			if(localStorage._client_onAir=='true'){
				$('#bem').attr('disabled','disabled');
				//$('#bum').removeAttr('disabled');
				//$('#br').removeAttr('disabled');
			}else{
				$('#bum').attr('disabled','disabled');
				$('#br').attr('disabled','disabled');
				//$('#bem').removeAttr('disabled');
			}
		}
		
		//Initialise controls and shoot off the loadUI & processHash functions
		$(function() {
			$("#tabs").tabs();
			loadState();
			loadUI();
			
			processHash();

			$('#bldb').file().choose(function(e, input) {
				handleFiles(input[0].files);
			});
		});
	</script>

	
	<!-- Change UA-XXXXX-X to be your site's ID -->
	<!--script>
		window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
		Modernizr.load({
			load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
		});
	</script-->


	<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
			 chromium.org/developers/how-tos/chrome-frame-getting-started -->
	<!--[if lt IE 7 ]>
		<script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
		<script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
	<![endif]-->
	
</body>
</html>
